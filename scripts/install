#!/bin/bash

#=================================================
# GENERIC START
#=================================================
# IMPORT GENERIC HELPERS
#=================================================

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# STOREÂ SETTINGS
#=================================================

domain=$(yunohost domain list --json | jq -r '.["main"]')
path=/.well-known/yunomonitor/

ynh_app_setting_set --app="$app" --key="domain" --value="$domain"
ynh_app_setting_set --app="$app" --key="path" --value="$path"

# FIXME: required?
ynh_export monitored_servers monitoring_servers mails sms_api


#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================
ynh_script_progression --message="Setting up source files..." --weight=1

ynh_setup_source --dest_dir="$install_dir"

chmod 750 "$install_dir"
chmod -R o-rwx "$install_dir"
chown -R "$app:www-data" "$install_dir"

#=================================================
# NGINX CONFIGURATION
#=================================================
ynh_script_progression --message="Configuring NGINX web server..." --weight=1

_yunomonitor_add_nginx_config

#=================================================
# SPECIFIC SETUP
#=================================================
# BUILD YUNOMONITOR
#=================================================
ynh_script_progression --message="Building Yunomonitor..."

pushd "$install_dir"
	python3 -m pip install pycryptodome
popd

#=================================================
# SETUP SYSTEMD
#=================================================
ynh_script_progression --message="Configuring a systemd service..."

ynh_add_systemd_config
ynh_add_config --template="systemd.timer" --destination="/etc/systemd/system/$app.timer"

systemctl daemon-reload
systemctl enable "$app.timer" --quiet
systemctl start "$app.timer"

#=================================================
# ADD A CONFIGURATION
#=================================================
ynh_script_progression --message="Adding a configuration file..."

echo "mails: [$mails]" > $install_dir/conf/$app.yml
echo "sms_apis: [$sms_api]" >> $install_dir/conf/$app.yml
echo "monitored_servers: [$monitored_servers]" >> $install_dir/conf/$app.yml
echo "monitoring_servers: [$monitoring_servers]" >> $install_dir/conf/$app.yml
echo "cachet_apis: []" >> $install_dir/conf/$app.yml
sed -i 's/,/","/g' $install_dir/conf/$app.yml
sed -i 's/\[/["/g' $install_dir/conf/$app.yml
sed -i 's/\]/"]/g' $install_dir/conf/$app.yml
sed -i 's/\[""\]/[]/g' $install_dir/conf/$app.yml

# Calculate and store the config file checksum into the app settings
ynh_store_file_checksum --file="$install_dir/conf/$app.yml"

#=================================================
# INIT IGNORE FILE
#=================================================

echo "method level server message target" > "$install_dir/conf/ignore_alert.csv"


# Set permissions to app files
chmod u+x "$install_dir/yunomonitor.py"
chmod u+w "$install_dir/conf"
chmod u+w "$install_dir/well-known"

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression --message="Installation of $app completed" --last
